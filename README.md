# Transformer from Scratch

[![GitHub](https://img.shields.io/badge/GitHub-luojun132/transformer-blue)](https://github.com/luojun132/transformer)

ä»é›¶å®ç°çš„Transformeræ¶æ„ï¼ŒåŒ…å«å®Œæ•´çš„è®­ç»ƒç®¡é“å’Œæ¶ˆèå®éªŒç³»ç»Ÿã€‚æœ¬é¡¹ç›®å®Œæ•´å®ç°äº†Transformerè®ºæ–‡ã€ŠAttention Is All You Needã€‹ä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œå¹¶åœ¨Tiny Shakespeareæ•°æ®é›†ä¸Šè¿›è¡Œäº†ç³»ç»Ÿçš„æ¶ˆèå®éªŒã€‚

## ğŸ¯ é¡¹ç›®ç‰¹ç‚¹

- âœ… **ä»é›¶å®ç°**æ‰€æœ‰Transformeræ ¸å¿ƒç»„ä»¶
- âœ… **å®Œæ•´çš„Encoder-Decoderæ¶æ„**
- âœ… **ç³»ç»Ÿçš„æ¶ˆèå®éªŒ** (ä½ç½®ç¼–ç ã€æ³¨æ„åŠ›å¤´æ•°ã€å±‚æ•°)
- âœ… **è‡ªåŠ¨åŒ–å®éªŒç»“æœå¯è§†åŒ–**
- âœ… **æ”¯æŒè¯­è¨€å»ºæ¨¡å’Œåºåˆ—åˆ°åºåˆ—ä»»åŠ¡**
- âœ… **å®Œæ•´çš„è®­ç»ƒç®¡é“** (AdamWä¼˜åŒ–å™¨ã€å­¦ä¹ ç‡è°ƒåº¦ã€æ¢¯åº¦è£å‰ª)

## ğŸ“ é¡¹ç›®ç»“æ„

```
transformer-from-scratch/
â”œâ”€â”€ src/                          # æºä»£ç 
â”‚   â”œâ”€â”€ model.py                  # Transformeræ¨¡å‹å®ç°
â”‚   â”œâ”€â”€ trainer.py                # è®­ç»ƒå™¨
â”‚   â”œâ”€â”€ data_loader.py            # æ•°æ®åŠ è½½ä¸é¢„å¤„ç†
â”‚   â”œâ”€â”€ utils.py                  # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ experiment.py             # å®éªŒç®¡ç†å™¨
â”‚   â””â”€â”€ seq2seq_data.py           # åºåˆ—åˆ°åºåˆ—æ•°æ®
â”œâ”€â”€ configs/                      # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ base.yaml                 # åŸºç¡€è®­ç»ƒé…ç½®
â”‚   â””â”€â”€ seq2seq.yaml              # åºåˆ—åˆ°åºåˆ—é…ç½®
â”œâ”€â”€ scripts/                      # è¿è¡Œè„šæœ¬
â”‚   â””â”€â”€ run.sh                    # å®Œæ•´å®éªŒè¿è¡Œè„šæœ¬
â”œâ”€â”€ results/                      # å®éªŒç»“æœ
â”‚   â”œâ”€â”€ ablation/                 # æ¶ˆèå®éªŒå›¾è¡¨
â”‚   â”‚   â”œâ”€â”€ positional_encoding_results.png
â”‚   â”‚   â”œâ”€â”€ heads_results.png
â”‚   â”‚   â”œâ”€â”€ layers_results.png
â”‚   â”‚   â””â”€â”€ ablation_report.md
â”‚   â””â”€â”€ training_curve.png        # è®­ç»ƒæ›²çº¿
â”œâ”€â”€ checkpoints/                  # æ¨¡å‹æ£€æŸ¥ç‚¹ç›®å½•
â”œâ”€â”€ data/                         # æ•°æ®é›†
â”‚   â””â”€â”€ tiny_shakespeare.txt      # Tiny Shakespeareæ•°æ®é›†
â”œâ”€â”€ model_backups/                # æ¨¡å‹æ–‡ä»¶å¤‡ä»½
â”œâ”€â”€ requirements.txt              # Pythonä¾èµ–
â”œâ”€â”€ README.md                     # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ run_ablation.py               # æ¶ˆèå®éªŒä¸»è„šæœ¬
â”œâ”€â”€ train.py                      # å•æ¬¡è®­ç»ƒè„šæœ¬
â””â”€â”€ train_seq2seq.py              # åºåˆ—åˆ°åºåˆ—è®­ç»ƒ
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **Python**: 3.8+
- **PyTorch**: 2.0+
- **å†…å­˜**: 4GB+ RAM
- **ç£ç›˜ç©ºé—´**: 2GB+
- **æ¨èç¡¬ä»¶**: GPU (CUDA) ç”¨äºåŠ é€Ÿè®­ç»ƒ

### å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### ç²¾ç¡®é‡ç°å®éªŒ

ä½¿ç”¨éšæœºç§å­42ç¡®ä¿ç»“æœå¯é‡ç°ï¼š

```bash
# æ–¹æ³•1: ä½¿ç”¨è¿è¡Œè„šæœ¬
chmod +x scripts/run.sh
./scripts/run.sh

# æ–¹æ³•2: ç›´æ¥è¿è¡Œæ¶ˆèå®éªŒ
export PYTHONPATH=$PYTHONPATH:$(pwd)
python run_ablation.py
```

### å•æ¬¡è®­ç»ƒ

```bash
python train.py
```

### åºåˆ—åˆ°åºåˆ—è®­ç»ƒ

```bash
python train_seq2seq.py
```

## âš™ï¸ ç¡¬ä»¶è¦æ±‚ä¸è®­ç»ƒæ—¶é—´

| é…ç½® | ç¡¬ä»¶è¦æ±‚ | è®­ç»ƒæ—¶é—´ | å¤‡æ³¨ |
|------|----------|----------|------|
| **æ¶ˆèå®éªŒ** | CPU, 8GB RAM | ~2å°æ—¶ | å®Œæ•´çš„ä½ç½®ç¼–ç ã€å¤´æ•°ã€å±‚æ•°å®éªŒ |
| **å•æ¬¡è®­ç»ƒ** | CPU, 4GB RAM | ~30åˆ†é’Ÿ | å•ä¸ªæ¨¡å‹è®­ç»ƒ |
| **GPUåŠ é€Ÿ** | NVIDIA GPU, 4GB VRAM | ~20åˆ†é’Ÿ | æ˜¾è‘—åŠ é€Ÿè®­ç»ƒ |

## ğŸ“Š æ ¸å¿ƒå®ç°

### æ¨¡å‹æ¶æ„

- **Multi-head Self-attention**: ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶
- **Position-wise Feed-Forward Networks**: ä½ç½®å‰é¦ˆç½‘ç»œ
- **æ®‹å·®è¿æ¥ + Layer Normalization**: ç¨³å®šè®­ç»ƒçš„å…³é”®ç»„ä»¶
- **æ­£å¼¦ä½ç½®ç¼–ç **: æä¾›åºåˆ—ä½ç½®ä¿¡æ¯
- **å®Œæ•´çš„Encoder-Decoderæ¶æ„**: æ”¯æŒåºåˆ—åˆ°åºåˆ—ä»»åŠ¡

### è®­ç»ƒç‰¹æ€§

- **AdamWä¼˜åŒ–å™¨**: å¸¦æƒé‡è¡°å‡çš„Adamä¼˜åŒ–å™¨
- **Cosine Annealingè°ƒåº¦**: ä½™å¼¦é€€ç«å­¦ä¹ ç‡è°ƒåº¦
- **æ¢¯åº¦è£å‰ª**: é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
- **è‡ªåŠ¨æ¨¡å‹ä¿å­˜**: æ™ºèƒ½æ£€æŸ¥ç‚¹ç®¡ç†
- **è®­ç»ƒè¿‡ç¨‹å¯è§†åŒ–**: å®æ—¶æŸå¤±æ›²çº¿ç»˜åˆ¶

## ğŸ“ˆ å®éªŒç»“æœ

### æ¶ˆèå®éªŒæ€§èƒ½å¯¹æ¯”

| å®éªŒé…ç½® | æœ€ç»ˆéªŒè¯æŸå¤± | æœ€ä½³éªŒè¯æŸå¤± | å…³é”®å‘ç° |
|----------|--------------|--------------|----------|
| **æœ‰ä½ç½®ç¼–ç ** | 0.0987 | 0.0987 | ä½ç½®ç¼–ç è‡³å…³é‡è¦ |
| **æ— ä½ç½®ç¼–ç ** | 2.8289 | 2.8289 | æ€§èƒ½ä¸‹é™28å€ |
| **2æ³¨æ„åŠ›å¤´** | 0.1478 | 0.1478 | åŸºç¡€æ€§èƒ½è¡¨ç° |
| **4æ³¨æ„åŠ›å¤´** | 0.0987 | 0.0987 | å¹³è¡¡çš„æ€§èƒ½ |
| **8æ³¨æ„åŠ›å¤´** | 0.0933 | 0.0933 | å¤šå¤´æ³¨æ„åŠ›ä¼˜åŠ¿ |
| **2å±‚Transformer** | 0.0987 | 0.0987 | æ ‡å‡†é…ç½® |
| **4å±‚Transformer** | 0.1232 | 0.1232 | è½»å¾®è¿‡æ‹Ÿåˆ |
| **6å±‚Transformer** | 0.0777 | 0.0777 | æœ€ä½³æ€§èƒ½ |

### å…³é”®å‘ç°

1. **ä½ç½®ç¼–ç çš„é‡è¦æ€§**: æœ‰ä½ç½®ç¼–ç çš„æ¨¡å‹æ€§èƒ½æ˜¾è‘—ä¼˜äºæ— ä½ç½®ç¼–ç æ¨¡å‹
2. **å¤šå¤´æ³¨æ„åŠ›ä¼˜åŠ¿**: å¢åŠ æ³¨æ„åŠ›å¤´æ•°å¸¦æ¥æŒç»­çš„æ€§èƒ½æå‡
3. **é€‚å½“æ¨¡å‹æ·±åº¦**: 6å±‚Transformeråœ¨æ•°æ®é›†ä¸Šè¡¨ç°æœ€ä½³
4. **è®­ç»ƒç¨³å®šæ€§**: æ‰€æœ‰é…ç½®éƒ½å±•ç°äº†è‰¯å¥½çš„æ”¶æ•›æ€§

## ğŸ”¬ å®éªŒè¯¦æƒ…

### ä½ç½®ç¼–ç æ¶ˆèå®éªŒ
éªŒè¯ä½ç½®ç¼–ç åœ¨Transformerä¸­çš„å…³é”®ä½œç”¨ï¼Œæ¯”è¾ƒæœ‰/æ— ä½ç½®ç¼–ç çš„æ€§èƒ½å·®å¼‚ã€‚

### æ³¨æ„åŠ›å¤´æ•°æ¶ˆèå®éªŒ
æ¢ç´¢å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸­å¤´æ•°å¯¹æ¨¡å‹æ€§èƒ½çš„å½±å“ï¼Œæ¯”è¾ƒ2å¤´ã€4å¤´ã€8å¤´çš„è¡¨ç°ã€‚

### å±‚æ•°æ¶ˆèå®éªŒ
ç ”ç©¶æ¨¡å‹æ·±åº¦å¯¹æ€§èƒ½çš„å½±å“ï¼Œæ¯”è¾ƒ2å±‚ã€4å±‚ã€6å±‚Transformerçš„è¡¨ç°ã€‚

## ğŸ› ï¸ è‡ªå®šä¹‰é…ç½®

ä¿®æ”¹ `configs/base.yaml` æ¥è°ƒæ•´å®éªŒè®¾ç½®ï¼š

```yaml
# æ¨¡å‹é…ç½®
d_model: 128
num_heads: 4
num_layers: 2
d_ff: 512
max_seq_len: 128
dropout: 0.1

# è®­ç»ƒé…ç½®
batch_size: 16
learning_rate: 0.002
weight_decay: 0.01
num_epochs: 8
random_seed: 42
```

## ğŸ“‹ æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒæ–‡ä»¶
- `src/model.py`: Transformeræ¨¡å‹å®Œæ•´å®ç°
- `src/trainer.py`: è®­ç»ƒå¾ªç¯å’Œæ¨¡å‹ä¿å­˜
- `src/experiment.py`: æ¶ˆèå®éªŒç®¡ç†ç³»ç»Ÿ
- `run_ablation.py`: æ¶ˆèå®éªŒä¸»å…¥å£

### ç»“æœæ–‡ä»¶
- `results/ablation/positional_encoding_results.png`: ä½ç½®ç¼–ç å®éªŒå›¾è¡¨
- `results/ablation/heads_results.png`: æ³¨æ„åŠ›å¤´æ•°å®éªŒå›¾è¡¨
- `results/ablation/layers_results.png`: å±‚æ•°å®éªŒå›¾è¡¨
- `results/ablation/ablation_report.md`: å®Œæ•´å®éªŒåˆ†ææŠ¥å‘Š

### æ•°æ®æ–‡ä»¶
- `data/tiny_shakespeare.txt`: è®­ç»ƒæ•°æ®é›†
- `checkpoints/`: æ¨¡å‹æ£€æŸ¥ç‚¹ç›®å½•ï¼ˆæ–‡ä»¶è¾ƒå¤§æ²¡æœ‰ä¸Šä¼ ï¼‰
- `model_backups/`: å¤§æ¨¡å‹æ–‡ä»¶å¤‡ä»½

- ä½¿ç”¨ [Tiny Shakespeare](https://github.com/karpathy/char-rnn/blob/master/data/tinyshakespeare/input.txt) æ•°æ®é›†è¿›è¡ŒéªŒè¯


*é¡¹ç›®æœ€åæ›´æ–°: 2024å¹´1æœˆ*  
*å¦‚é‡é—®é¢˜ï¼Œè¯·æäº¤Issueæˆ–è”ç³»ç»´æŠ¤è€…*
